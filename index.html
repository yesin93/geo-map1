<!DOCTYPE html>
<!--
~   Copyright (c) WSO2 Inc. (http://wso2.com) All Rights Reserved.
~
~   Licensed under the Apache License, Version 2.0 (the "License");
~   you may not use this file except in compliance with the License.
~   You may obtain a copy of the License at
~
~        http://www.apache.org/licenses/LICENSE-2.0
~
~   Unless required by applicable law or agreed to in writing, software
~   distributed under the License is distributed on an "AS IS" BASIS,
~   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
~   See the License for the specific language governing permissions and
~   limitations under the License.
-->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>WSO2 Stream Processor</title>
    <link href="libs/theme-wso2_2.0.0/images/favicon.png" rel="icon" type="image/png" sizes="16x16"/>
    <!-- WSO2 Theme -->
    <link href="libs/theme-wso2_2.0.0/css/theme-wso2.css" rel="stylesheet" type="text/css"/>

    <!-- Font WSO2 CSS -->
    <link href="libs/font-wso2_1.1.1/css/font-wso2.min.css" rel="stylesheet" type="text/css"/>

    <!--fontawesome-->
    <link href="libs/font-awesome_4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <!--leaflet-->
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link rel="stylesheet" href="css/leaflet-sidebar.min.css"/>

    <link href="libs/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet" type="text/css"/>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body class="sticky-footer fixed">

<!-- header -->
<header class="header header-default">
    <div class="container-fluid">
        <div class="pull-left brand">
            <a href="#">
                <img src="libs/theme-wso2_2.0.0/images/logo-inverse.svg" alt="wso2" title="wso2" class="logo">
                <span>IoT Server Floorplan Visualizer</span>
            </a>
        </div>
        <!--<ul class="nav navbar-right">
            <li class="visible-inline-block">
                <a class="dropdown" data-toggle="dropdown" aria-expanded="false">
                       <span class="icon fw-stack">
                          <i class="fw fw-circle fw-stack-2x"></i>
                          <i class="fw fw-user fw-stack-1x fw-inverse"></i>
                       </span>
                    <span class="hidden-xs add-margin-left-1x">John Doe <span class="caret"></span></span>
                </a>
                <ul class="dropdown-menu dropdown-menu-right slideInDown" role="menu">
                    <li><a href="#">Profile Settings</a></li>
                    <li><a href="#">Logout</a></li>
                </ul>
            </li>
        </ul>-->
    </div>
</header>
<!-- /header -->

<!-- breadcrumb -->
<!--<div class="breadcrumb-wrapper">-->
<!--<ol class="breadcrumb">-->
<!--<li><a href="/"><i class="icon fw fw-home"></i> <span class="hidden-xs">Map</span></a></li>-->
<!--</ol>-->
<!--</div>-->


<!-- navbar -->
<div class="navbar-wrapper">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <div class="navbar-brand">
                    <a href="#">Geographic View</a>
                </div>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="#" onclick="onAddMarker()">
                                <span class="icon fw-stack">
                                    <i class="fw fw-add fw-helper fw-helper-circle-outline"></i>
                                </span>
                            Add Location
                        </a>
                    </li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>
</div>
<!-- /navbar -->


<div class="page-content-wrapper">

    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-home"></i></a></li>
                <!--<li><a href="#info" role="tab"><i class="fa fa-info-circle"></i></a></li>-->
                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
            </ul>

        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    Home
                    <span class="sidebar-close"><i class="fa fa-caret-right"></i></span>
                </h1>
            </div>

            <!--&lt;!&ndash;Rough view of form &ndash;&gt;-->
            <!--<div class="sidebar-pane" id="info">-->
                <!--<h1 class="sidebar-header">Pull Device/Location Info<span class="sidebar-close"><i-->
                        <!--class="fa fa-caret-right"></i></span></h1>-->
                <!--&lt;!&ndash;Info form editable&ndash;&gt;-->
                <!--<div class="container-fluid">-->
                    <!--<div class="row">-->
                        <!--<div class="col-md-12 col-sm-12 col-xs-12">-->
                            <!--<h1>Device Details</h1>-->

                            <!--<form action="" method="post" id="register-form" novalidate="novalidate">-->
                                <!--<div class="form-group">-->
                                    <!--<label for="locationName">Location Name*</label>-->
                                    <!--<input type="text" class="form-control" name="locationName" id="locationName"-->
                                           <!--placeholder="Home"></div>-->
                                <!--<br/>-->
                                <!--<div class="form-group">-->
                                    <!--<label for="address">Address*</label>-->
                                    <!--<input type="text" class="form-control" name="address" id="address"-->
                                           <!--placeholder="13/13, Mockingbird Ave, New York"></div>-->
                                <!--<br/>-->
                                <!--<div class="form-group">-->
                                    <!--<label for="floors">No. of Floors*</label>-->
                                    <!--<input type="number" class="form-control required" id="floors" name="floors"-->
                                           <!--placeholder="Number of floors"></div>-->
                                <!--<br/>-->
                                <!--&lt;!&ndash;            <div style="margin-left:140px;">&ndash;&gt;-->
                                <!--<button type="button" class="btn btn-secondary" onclick="pushStuff()">Save</button>-->
                                <!--<button type="button" class="btn btn-primary">View Devices</button>-->
                            <!--</form>-->


                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->

            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-right"></i></span>
                </h1>
            </div>
        </div>
    </div>

    <div id="openStreetMapId" style="height:100%"></div>

</div>

<footer class="footer">
    <div class="container-fluid">
        <p>WSO2 <span class="hidden-xs">IoT Server Floorplan Visualizer</span> | &copy;
            <script>document.write(new Date().getFullYear());</script>
            <a href="http://wso2.com/" target="_blank"><i class="icon fw fw-wso2"></i> Inc</a>.
        </p>
    </div>
</footer>

<!-- jQuery (necessary for Bootstrap and WSO2 Theme JavaScript plugins) -->
<script src="libs/jquery_1.11.0/jquery-1.11.3.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="libs/bootstrap_3.3.6/js/bootstrap.min.js"></script>
<script src="libs/theme-wso2_2.0.0/js/theme-wso2.min.js"></script>

<!--sidebar js-->
<script src="js/leaflet.js"></script>
<script src="js/leaflet-sidebar.min.js"></script>
<script src="js/jquery-sidebar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.1/jquery.validate.min.js"></script>

<!--scripts-->
<script type="text/javascript">

</script>

<!--scripts-->
<script type="text/javascript">

    //image bounds
    var baseMap;

    //Array to store marker latlng and ID
    var markers = [];

    // quick and dirty: create a big icon
    L.Icon.Big = L.Icon.Default.extend({
        options: {
            iconSize: new L.Point(30, 49),
        }
    });

    //THE ICONS
    var bigIcon = new L.Icon.Big();
    var smallIcon = new L.Icon.Default();

    //marker
    //    var marky;


    //on load
    initialiseMap();

    //add base map
    function initialiseMap() {

        //Renders map to user's current location
        baseMap = L.map('openStreetMapId').locate({setView: true, maxZoom: 17, animate: true, duration: 3});

        var sidebar = L.control.sidebar('sidebar', {position: 'right'}).addTo(baseMap);

        //Rendering resources
        L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: 'Map data Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, CC-BY-SA.'
        }).addTo(baseMap);

        //show current location
        baseMap.on('locationfound', showMe);
        function showMe(e) {
            popup.setLatLng(e.latlng).setContent("Hi! You're Here")
                    .openOn(baseMap)
                    .keepInView;
        }

        //On location error
        function onLocationError(e) {
            alert(e.message);
        }

        baseMap.on('locationerror', onLocationError);


        var popup = L.popup();

//
//        function onMapClick(e) {
//            popup
//                    .setLatLng(e.latlng)
//                    .setContent("You clicked the map at " + e.latlng.toString())
//                    .openOn(baseMap);
//        }
//
//        baseMap.on('click', onMapClick);
    }

    //    reading data from JSON
    $(document).ready(function () {
        $.get('result.json', function (data) {
            $.each(data.metaData, function(i, n){
                addingMarker(null, n);
            });


        });
    });

    var markerID;
    //open new window onclick
    function openWin() {
        window.open("visualizer.html?id='+markerID+'");
    }

    $('#home').on('click', '[data-toggle=save-data]', function(e){
        if($(e.target).closest('form').valid()) {
            var id = element.prop('id');
            markerID = id;
            openWin();
        }
    });

    // Script for adding marker
    function addingMarker(e, d) {
        console.log(d);

        var cord,
            locationName,
            address,
            floorCount;

        if(e !== null){
            cord = e.latlng;
            locationName = "";
            address = "";
            floorCount = "";
        }
        else {
            cord = L.latLng(d.coordinates.lat, d.coordinates.lng);
            locationName = d.locationName;
            address = d.address;
            floorCount = d.floors;
        }

        //variable for marker
        var marker;

        //markers info JSON array
        var markerInfo = {
            info: []
        };

        marker = new L.marker(cord, {

            title: "Resource Location",
            alt: "Resource Location",
            riseOnHover: true,
            draggable: true

        }).bindPopup("<input type='button' value='Delete' class='marker-delete-button'/>");
        marker.on('click', onMarkerClick);

        marker.on("popupopen", onPopupOpen);

        marker.addTo(baseMap);
        markers[marker._leaflet_id] = marker;
//        markerID = marker._leaflet_id;
        //console.log(marker);

        //append the information to the sidebar
        $('#home').append(
                '<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">'+
                '<div class="item" id="' + marker._leaflet_id + '" data-lat="' + marker._latlng.lat + '" data-lng="' + marker._latlng.lng + '" data-toggle="collapse" data-target="marker_content_panel_' + marker._leaflet_id + '">' +
                '<h3>Marker ' + marker._leaflet_id + '</h3>' +
                '<a href="#" class="remove" id="' + marker._leaflet_id + '">' +
                '<span class="icon fw-stack">' +
                '<i class="fw fw-delete fw-stack-1x"></i>' +
                '</span> Remove' +
                '</a>' +
                '<form action="" method="post" id="register-form" novalidate="novalidate">' +
                '<div class="form-group">' +
                '<label for="locationName">Location Name *</label>' +
                '<input type="text" class="form-control" name="locationName" placeholder="Home" value="' + locationName + '">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="address">Address *</label>' +
                '<input type="text" class="form-control" name="address" placeholder="13/13, Mockingbird Ave, New York" value="'+address+'">' +
                '</div>' +
                '<div class="form-group">' +
                '<label for="floors">No. of Floors *</label>' +
                '<input type="number" class="form-control required" name="floors" placeholder="Number of floors" value="'+floorCount+'">' +
                '</div>' +
                '<div class="form-group">' +
                '<button type="button" class="btn btn-primary" data-toggle="update-data">Save</button>' +
                '<button type="button" class="btn btn-secondary" toggle-data="save-data">Edit Floors</button>' +
                '</div>' +
                '</form>' +
                '</div>');

//            id selector of list items
        var idNo = $('.item').attr('id');


        // Remove a marker
        $('.remove').on("click", function () {
            // Remove the marker
            baseMap.removeLayer(markers[$(this).attr('id')]);

            var idNo = $(this).attr('id');
            // Remove the link
            $(this).parent('div').remove();

            $('#home').find('#' + idNo).remove();
        });

        //On Mouseover the markers
        $('.item').on("mouseover", function (e) {
            $('div').removeClass('active-marker');
            $(this).addClass('active-marker');
            for (var mark in markers) {
                markers[mark].setIcon(smallIcon);
            }
            markerFunction($(this).attr('id'))
            markers[$(this).attr('id')].setIcon(bigIcon);
            var mid = $(this).attr('id');
            var LatLng = markers[mid].getLatLng();
            var offset = baseMap.panTo(LatLng);
            baseMap.panBy(offset);
        });
    }

    //open marker popup
    function markerFunction(id) {
        markers[id].openPopup();

        //Extra added stuff
//          $(".marker-delete-button:visible").click(function(){
//              // Remove the marker
//              baseMap.removeLayer(markers[$(this).attr('id')]);
//
//              // Remove the link
//              $(this).parent('div').remove();
//          })
//until here
    }


    // Function to handle delete as well as other events on marker popup open
    function onPopupOpen() {

        var tempMarker = this;

        //var tempMarkerGeoJSON = this.toGeoJSON();

        //var lID = tempMarker._leaflet_id; // Getting Leaflet ID of this marker

        // To remove marker on click of delete
//            $(".marker-delete-button:visible").click(function () {
//                baseMap.removeLayer(tempMarker);
//            });
        // Remove the marker
//            baseMap.removeLayer(markers[$(this).attr('id')]);
//
//            // Remove the link
//            $(this).parent('div').remove();
    }

    //Set
    function onMarkerClick(e) {
        $('div').removeClass('active-marker');
        $('div #' + e.target._leaflet_id).addClass('active-marker');
        for (var mark in markers) {
            markers[mark].setIcon(smallIcon);
        }
        var offset = baseMap.panTo(markers[mark].getLatLng());
        baseMap.panBy(offset);
    }

    function onAddMarker() {
        baseMap.once('click', addingMarker);
    }


    //remove the markers
    //    function removeMarky() {
    //        baseMap.on('dblclick', removeMarker);
    //        function removeMarker(e) {
    //            var daLocation = e.latlng;
    //            baseMap.removeLayer();
    //        }
    //    }


    //remove svg map
    //    function removeMarker(){
    //        //remove layer
    ////        baseMap.removeLayer(svgMapOverlay);
    //        document.getElementById("Register").value == "Register Location";
    //        hideControlButtons();
    ////        clearValuesInTextBox();
    //        opacitySlider.removeFrom(baseMap);
    //        isOpacityNotSet = true;
    //
    //    }


</script>

<script src="js/createJSON.js"></script>


</body>
</html>